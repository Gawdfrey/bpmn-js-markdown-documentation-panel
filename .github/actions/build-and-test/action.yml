name: "Build and Test"
description: "Build packages and run quality checks including tests"

inputs:
  skip-quality-checks:
    description: "Skip quality checks (type-check, lint, format)"
    required: false
    default: "false"

  skip-tests:
    description: "Skip running tests"
    required: false
    default: "false"

  skip-build:
    description: "Skip build step"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Run quality checks
      if: inputs.skip-quality-checks != 'true'
      run: |
        echo "ğŸ” Running quality checks..."
        pnpm run type-check
        pnpm run format-and-lint
        pnpm run knip
        echo "âœ… Quality checks completed"
      shell: bash

    - name: Install Playwright browsers
      if: inputs.skip-tests != 'true'
      run: |
        pnpm --filter bpmn-js-markdown-documentation-panel exec playwright install --with-deps chromium
      shell: bash

    - name: Run tests
      if: inputs.skip-tests != 'true'
      run: |
        echo "ğŸ§ª Running test suite..."
        pnpm run test
        echo "âœ… All tests passed"
      shell: bash

    - name: Build packages
      if: inputs.skip-build != 'true'
      run: |
        echo "ğŸ”¨ Building packages..."
        pnpm run build
        echo "âœ… Build completed"
      shell: bash

    - name: Verify build artifacts
      if: inputs.skip-build != 'true'
      run: |
        echo "ğŸ” Verifying build artifacts..."

        # Check critical build outputs exist
        if [ ! -f "packages/bpmn-js-markdown-documentation-panel/dist/bpmn-js-entry.js" ]; then
          echo "âŒ ESM build missing"
          exit 1
        fi
        if [ ! -f "packages/bpmn-js-markdown-documentation-panel/dist/camunda-modeler-entry.js" ]; then
          echo "âŒ CommonJS build missing"
          exit 1
        fi
        if [ ! -f "packages/bpmn-js-markdown-documentation-panel/dist/index.js" ]; then
          echo "âŒ Plugin manifest missing"
          exit 1
        fi
        if [ ! -f "packages/bpmn-js-markdown-documentation-panel/dist/style.css" ]; then
          echo "âŒ Styles missing"
          exit 1
        fi
        echo "âœ… All build artifacts present"
      shell: bash

